<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Library Visit — Day / Night Toggle</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Light (default) */
      --bg:#ffffff; 
      --paper:#ffffff; 
      --ink:#0b0b0b; 
      --muted:#4b4b4b; 
      --outline:rgba(11,11,11,0.12);
      --ambient: rgba(0,0,0,0.06);

      --radius:18px;
      --fs-xxl:42px; --fs-xl:34px; --fs-lg:24px; --fs-md:18px; --fs-sm:15px;
      --btn-h:64px; --btn-radius:14px; --maxw:1100px;

      --transition-fast: 180ms cubic-bezier(.2,.9,.2,1);
      --transition-medium: 320ms cubic-bezier(.2,.9,.2,1);
    }

    /* Dark theme overrides when data-theme="dark" is set on <html> */
    html[data-theme="dark"] {
      --bg: #071017;
      --paper: #0b1b23;
      --ink: #e9f3fb;
      --muted: #95aac0;
      --outline: rgba(255,255,255,0.06);
      --ambient: rgba(255,255,255,0.03);
    }

    /* global */
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;transition:background var(--transition-medium), color var(--transition-medium)}
    *{box-sizing:border-box}
    /* wireframe grid background */
    body::before{
      content:"";
      position:fixed;inset:0;z-index:-3;
      background-image:
        linear-gradient(to right, var(--ambient) 1px, transparent 1px),
        linear-gradient(to bottom, var(--ambient) 1px, transparent 1px);
      background-size: 120px 120px, 120px 120px;
      opacity:0.7;
      transition:opacity var(--transition-medium);
    }

    .ambient-line{
      position:fixed;left:-30%;top:12%;width:160%;height:220px;background:
      linear-gradient(90deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02), rgba(0,0,0,0.06));
      transform:rotate(-6deg);filter:blur(8px);z-index:-2;animation:amb 12s linear infinite;border-radius:30px;
      transition:background var(--transition-medium), filter var(--transition-medium);
    }
    html[data-theme="dark"] .ambient-line{
      background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01), rgba(255,255,255,0.03));
      filter: blur(10px);
    }
    @keyframes amb{0%{transform:translateX(-12%) rotate(-6deg)}50%{transform:translateX(6%) rotate(-6deg)}100%{transform:translateX(-12%) rotate(-6deg)}}

    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px}
    .container{
      width:min(var(--maxw),96vw);
      background:var(--paper);
      border-radius:var(--radius);
      padding:28px;
      box-shadow: 0 10px 40px rgba(11,11,11,0.04);
      border: 1px solid var(--outline);
      position:relative;
      transition: box-shadow var(--transition-medium), border-color var(--transition-medium), background var(--transition-medium);
    }

    /* header */
    .header{display:flex;align-items:center;gap:18px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:18px}
    .logo{width:92px;height:92px;border-radius:14px;border:2px dashed var(--outline);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;color:var(--ink);transition:border-color var(--transition-fast), color var(--transition-fast)}
    .title h1{margin:0;font-size:var(--fs-xxl);line-height:1;transition:color var(--transition-fast)}
    .subtitle{color:var(--muted);font-size:var(--fs-md);margin-top:8px;transition:color var(--transition-fast)}

    /* theme toggle */
    .controls{display:flex;gap:10px;align-items:center}
    .themeToggle{
      display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:12px;border:1px solid var(--outline);cursor:pointer;background:transparent;
      transition:transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
      height:44px;
    }
    .themeToggle:active{transform:translateY(1px)}
    .themeIcon{width:22px;height:22px;display:inline-block;transition:transform .45s cubic-bezier(.2,.9,.2,1),opacity .2s}
    .themeLabel{font-weight:700;color:var(--muted);font-size:13px}

    /* search */
    .searchRow{margin-top:20px;display:flex;gap:14px;align-items:center}
    .searchCard{flex:1;padding:14px;border-radius:14px;border:2px solid var(--outline);display:flex;gap:12px;align-items:center;background:transparent;position:relative;transition:border-color var(--transition-fast)}
    .input{flex:1;padding:16px 18px;border-radius:10px;border:1px dashed var(--outline);font-size:var(--fs-lg);outline:none;background:transparent;color:var(--ink);min-height:56px;transition:border-color var(--transition-fast), box-shadow var(--transition-fast)}
    .input:focus{box-shadow:0 6px 20px rgba(0,0,0,0.06);border-color:var(--ink)}
    .btn{height:var(--btn-h);min-width:160px;padding:0 26px;border-radius:var(--btn-radius);display:inline-flex;align-items:center;justify-content:center;font-weight:800;font-size:var(--fs-md);cursor:pointer;background:transparent;border:2px solid var(--ink);color:var(--ink);position:relative;overflow:hidden;transition:all var(--transition-fast)}
    .btn.ghost{border-style:dashed}
    .btn.big{min-width:220px}

    /* suggestions */
    .suggestions{position:absolute;left:14px;right:14px;top:calc(100% + 10px);background:var(--paper);border:1px solid var(--outline);border-radius:12px;box-shadow:0 14px 40px rgba(11,11,11,0.06);max-height:340px;overflow:auto;z-index:140;display:none;padding:8px;transition:opacity var(--transition-fast)}
    .suggestions.show{display:block}
    .suggestion{padding:10px 12px;border-radius:10px;display:flex;gap:12px;align-items:center;cursor:pointer;border:1px dashed transparent;transition:background .12s, border-color .12s, transform .08s}
    .suggestion:hover, .suggestion.active{background:var(--ambient);border-color:var(--outline);transform:translateY(-2px)}
    .s-avatar{width:56px;height:56px;border-radius:8px;border:1px dashed var(--outline);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted);background:transparent;flex-shrink:0}
    .s-meta{flex:1}
    .s-name{font-weight:700;font-size:16px}
    .s-id{font-size:13px;color:var(--muted);margin-top:4px}
    .s-course{font-size:13px;color:var(--muted);margin-top:6px}
    .match{font-weight:800;text-decoration:underline}

    /* result card */
    .resultCard{margin-top:18px;padding:18px;border-radius:12px;border:2px solid var(--outline);display:none;background:transparent;transition:transform var(--transition-medium),opacity var(--transition-medium)}
    .resultCard.show{display:block;opacity:1;transform:translateY(0)}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .who strong{font-size:var(--fs-lg);margin:0}
    .who small{color:var(--muted);font-size:var(--fs-md);margin-top:8px}
    .avatar{width:100px;height:100px;border-radius:12px;border:2px dashed var(--outline);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted);font-size:18px;overflow:hidden;opacity:0;transform:translateY(8px);transition:opacity .3s, transform .3s}
    .avatar.show{opacity:1;transform:translateY(0)}
    .status{font-weight:800;padding:10px 14px;border-radius:12px;border:2px solid var(--outline);font-size:var(--fs-md)}
    .actions{margin-top:14px;display:flex;gap:12px;align-items:center;opacity:0;transform:translateY(6px);transition:opacity .3s .12s,transform .3s .12s}
    .actions.show{opacity:1;transform:translateY(0)}
    .timestamps{margin-top:12px;color:var(--muted);font-size:var(--fs-md)}

    /* confirm modal */
    .confirmBackdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.06);z-index:150}
    .confirmBackdrop.show{display:flex}
    .confirmDialog{width:min(580px,94vw);border-radius:12px;padding:18px;background:linear-gradient(180deg,var(--paper),#fafafa);border:2px solid var(--outline);box-shadow:0 30px 100px rgba(11,11,11,0.04)}
    .confirmDialog h3{margin:0;font-size:20px}
    .confirmDetails{margin-top:12px;padding:12px;border-radius:10px;border:1px dashed var(--outline);display:flex;gap:12px;align-items:center}
    .c-avatar{width:68px;height:68px;border-radius:10px;border:2px dashed var(--outline);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)}
    .c-meta{flex:1}
    .c-meta .line{font-size:16px;margin:4px 0}
    .confirmActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

    /* welcome */
    .backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.06);z-index:120}
    .backdrop.show{display:flex}
    .welcome{width:min(920px,94vw);border-radius:16px;padding:22px;background:linear-gradient(180deg,var(--paper),#fafafa);border:2px solid var(--outline);box-shadow:0 30px 100px rgba(11,11,11,0.04);animation:dialogIn .64s}
    @keyframes dialogIn{0%{opacity:0;transform:scale(.98) translateY(20px)}60%{transform:scale(1.02) translateY(-8px);opacity:1}100%{transform:none}}
    .confirmSmall{margin-top:12px;padding:12px;border-radius:12px;border:2px dashed var(--outline);display:flex;gap:12px;align-items:center;background:transparent;opacity:0;transform:translateY(8px);transition:opacity .28s,transform .28s}
    .confirmSmall.show{opacity:1;transform:translateY(0)}
    .iconWrap{width:64px;height:64px;border-radius:12px;border:2px dashed var(--outline);display:flex;align-items:center;justify-content:center}
    .detailsCompact{font-size:var(--fs-md)}
    .detailsLabel{color:var(--muted);font-size:var(--fs-sm);display:block}

    /* out overlay */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:130}
    .overlay.show{display:flex}
    .confirmCard{width:min(760px,94vw);padding:22px;border-radius:18px;text-align:center;background:linear-gradient(180deg,var(--paper),#fafafa);border:2px solid var(--outline)}
    svg.stroke circle, svg.stroke path{fill:none;stroke:var(--ink);stroke-width:3;stroke-linecap:round;stroke-linejoin:round}
    svg.stroke circle{stroke-dasharray:400;stroke-dashoffset:400;animation:strokeIn .9s ease forwards}
    svg.stroke path{stroke-dasharray:200;stroke-dashoffset:200;animation:strokeTick .6s ease .6s forwards}
    @keyframes strokeIn{to{stroke-dashoffset:0}} @keyframes strokeTick{to{stroke-dashoffset:0}}

    /* responsive */
    @media (max-width:880px){ :root{--fs-xxl:34px;--fs-xl:28px;--btn-h:60px} .logo{width:72px;height:72px} .avatar{width:84px;height:84px} }
    @media (max-width:520px){ :root{--fs-xxl:30px;--fs-xl:22px;--fs-lg:20px;--btn-h:56px} .header{flex-direction:column;align-items:flex-start;gap:12px} .searchRow{flex-direction:column;align-items:stretch} .btn{width:100%} .suggestions{left:8px;right:8px} }
  </style>
</head>
<body>
  <div class="ambient-line" aria-hidden="true"></div>

  <div class="wrap">
    <div class="container" role="main" aria-label="Library Visit — Confirmed Search">
      <div class="header" role="banner">
        <div class="brand">
          <div class="logo" aria-hidden="true">LIB</div>
          <div class="title">
            <h1>Welcome to the Library</h1>
            <div class="subtitle">Type a name — confirm Member ID & Course for duplicates</div>
          </div>
        </div>

        <div class="controls" aria-hidden="false">
          <div id="themeToggle" class="themeToggle" role="button" aria-pressed="false" aria-label="Toggle theme">
            <!-- icon swaps based on theme (JS toggles rotation) -->
            <svg id="themeIcon" class="themeIcon" viewBox="0 0 24 24" width="22" height="22" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path id="themeIconPath" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="themeLabel" id="themeLabel">Day</div>
          </div>
        </div>
      </div>

      <div class="searchRow" aria-label="Search member">
        <div class="searchCard" role="search">
          <input id="query" class="input" placeholder="Enter Member ID or Name" aria-label="Member ID or Name" autocomplete="off" />
          <button id="searchBtn" class="btn" aria-label="Search">Search</button>
          <button id="rulesBtn" class="btn ghost" aria-label="Rules">Rules</button>

          <div id="suggestions" class="suggestions" role="listbox" aria-label="Name suggestions"></div>
        </div>
      </div>

      <div id="resultCard" class="resultCard" aria-live="polite" aria-atomic="true">
        <div class="row" style="align-items:center">
          <div style="display:flex;gap:16px;align-items:center">
            <div id="avatar" class="avatar" aria-hidden="true">—</div>
            <div>
              <div class="who">
                <strong id="memberName">—</strong>
                <small id="memberId">ID: —</small>
              </div>
              <div id="memberAdditional" class="timestamps" style="margin-top:8px"></div>
            </div>
          </div>

          <div style="text-align:right">
            <div id="statusBadge" class="status out">—</div>
            <div id="today" style="margin-top:10px;color:var(--muted);font-size:var(--fs-sm)"></div>
          </div>
        </div>

        <div id="actionRow" class="actions">
          <button id="visitInBtn" class="btn big">Visit In</button>
          <button id="visitOutBtn" class="btn ghost">Visit Out</button>
        </div>

        <div id="timestamps" class="timestamps">—</div>
      </div>

      <div id="adminPanel" style="margin-top:18px;display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="color:var(--muted);font-size:var(--fs-sm)">Admin</div>
          <div style="display:flex;gap:8px">
            <button id="exportTodayBtn" class="btn ghost">Export</button>
            <button id="genDurationsBtn" class="btn ghost">Durations</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Suggestion -> Confirm dialog -->
  <div id="confirmBackdrop" class="confirmBackdrop" aria-hidden="true">
    <div class="confirmDialog" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">Confirm Member</h3>
      <p style="margin:8px 0;color:var(--muted)">Please confirm Member ID and Course before proceeding — this prevents duplicate-name errors.</p>

      <div class="confirmDetails" id="confirmDetails">
        <div id="cAvatar" class="c-avatar">—</div>
        <div class="c-meta">
          <div class="line"><strong id="cd_name">—</strong></div>
          <div class="line"><span class="detailsLabel">Member ID:</span> <span id="cd_id">—</span></div>
          <div class="line"><span class="detailsLabel">Course:</span> <span id="cd_course">—</span></div>
        </div>
      </div>

      <div class="confirmActions">
        <button id="cd_cancel" class="btn ghost">Cancel</button>
        <button id="cd_confirm" class="btn">Confirm & Select</button>
      </div>
    </div>
  </div>

  <!-- Welcome dialog (shown after Visit In or idle) -->
  <div id="welcomeBackdrop" class="backdrop" aria-hidden="true">
    <div class="welcome" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
      <h2 id="welcomeTitle">Welcome to the Library</h2>
      <p style="margin-top:8px;color:var(--muted)">Thanks for checking in — observe rules while you're here.</p>

      <div id="confirmSmall" class="confirmSmall" aria-hidden="true">
        <div class="iconWrap" aria-hidden="true">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="stroke">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H19" />
            <path d="M4 5.5A2.5 2.5 0 0 1 6.5 3H19v14" />
            <path d="M9 11l2 2 4-4" />
          </svg>
        </div>
        <div>
          <div class="detailsCompact"><span class="detailsLabel">Member</span> <strong id="c_memberName">—</strong></div>
          <div class="detailsCompact" style="margin-top:6px"><span class="detailsLabel">Member ID</span> <span id="c_memberId">—</span></div>
          <div class="detailsCompact" style="margin-top:6px"><span class="detailsLabel">Time In</span> <span id="c_timeIn">—</span></div>
        </div>
      </div>

      <div class="rules" style="margin-top:12px">
        <ol>
          <li><strong>Maintain silence.</strong></li>
          <li><strong>Phones on silent.</strong></li>
          <li><strong>Food & drinks:</strong> closed water bottles only.</li>
          <li><strong>Care for materials.</strong></li>
        </ol>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:14px">
        <button id="closeWelcomeBtn" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Visit Out overlay -->
  <div id="outOverlay" class="overlay" aria-hidden="true">
    <div class="confirmCard" role="status" aria-live="polite">
      <svg class="stroke" width="100" height="100" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
        <circle cx="60" cy="60" r="48" />
        <path d="M40 64 L54 78 L82 46" />
      </svg>
      <div style="font-size:20px;font-weight:800;margin-top:12px">Checked Out</div>
      <div class="detailsBox" style="margin-top:12px">
        <div><span class="detailsLabel">Member:</span> <span id="o_memberName">—</span></div>
        <div><span class="detailsLabel">Member ID:</span> <span id="o_memberId">—</span></div>
        <div><span class="detailsLabel">Time Out:</span> <span id="o_timeOut">—</span></div>
      </div>
    </div>
  </div>

  <div id="toast" style="position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#000;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:160"></div>

  <script>
    // theme handling
    const THEME_KEY = 'lib_theme'; // 'light' | 'dark'
    const htmlEl = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const themeIcon = document.getElementById('themeIcon');

    function setTheme(theme) {
      if (theme === 'dark') {
        htmlEl.setAttribute('data-theme','dark');
        themeLabel.textContent = 'Night';
        themeToggle.setAttribute('aria-pressed','true');
        themeIcon.style.transform = 'rotate(40deg)';
      } else {
        htmlEl.removeAttribute('data-theme');
        themeLabel.textContent = 'Day';
        themeToggle.setAttribute('aria-pressed','false');
        themeIcon.style.transform = 'rotate(0deg)';
      }
      try { localStorage.setItem(THEME_KEY, theme); } catch(e){}
    }

    function toggleTheme(){
      const cur = localStorage.getItem(THEME_KEY) || 'light';
      setTheme(cur === 'dark' ? 'light' : 'dark');
    }

    // initialize theme from localStorage or system preference
    (function initTheme(){
      let t = 'light';
      try { const saved = localStorage.getItem(THEME_KEY); if (saved) t = saved; else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) t = 'dark'; } catch(e){}
      setTheme(t);
    })();

    themeToggle.addEventListener('click', toggleTheme);
    themeToggle.addEventListener('keydown', (e)=> { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleTheme(); } });

    // rest of JS (typeahead + existing app hooks) - unchanged except small UI pieces
    const queryEl = document.getElementById('query');
    const searchBtn = document.getElementById('searchBtn');
    const rulesBtn = document.getElementById('rulesBtn');
    const suggestionsEl = document.getElementById('suggestions');

    const resultCard = document.getElementById('resultCard');
    const avatar = document.getElementById('avatar');
    const memberNameEl = document.getElementById('memberName');
    const memberIdEl = document.getElementById('memberId');
    const memberAdditional = document.getElementById('memberAdditional');
    const statusBadge = document.getElementById('statusBadge');
    const timestamps = document.getElementById('timestamps');
    const todayEl = document.getElementById('today');

    const actionRow = document.getElementById('actionRow');
    const visitInBtn = document.getElementById('visitInBtn');
    const visitOutBtn = document.getElementById('visitOutBtn');

    const confirmBackdrop = document.getElementById('confirmBackdrop');
    const cd_name = document.getElementById('cd_name');
    const cd_id = document.getElementById('cd_id');
    const cd_course = document.getElementById('cd_course');
    const cAvatar = document.getElementById('cAvatar');
    const cd_confirm = document.getElementById('cd_confirm');
    const cd_cancel = document.getElementById('cd_cancel');

    const welcomeBackdrop = document.getElementById('welcomeBackdrop');
    const confirmSmall = document.getElementById('confirmSmall');
    const c_memberName = document.getElementById('c_memberName');
    const c_memberId = document.getElementById('c_memberId');
    const c_timeIn = document.getElementById('c_timeIn');
    const closeWelcomeBtn = document.getElementById('closeWelcomeBtn');

    const outOverlay = document.getElementById('outOverlay');
    const o_memberName = document.getElementById('o_memberName');
    const o_memberId = document.getElementById('o_memberId');
    const o_timeOut = document.getElementById('o_timeOut');

    const toast = document.getElementById('toast');

    todayEl.textContent = new Date().toLocaleDateString();

    function debounce(fn, wait){
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(()=> fn.apply(this, args), wait); };
    }

    let suggestions = [];
    let activeIndex = -1;
    let selectedSuggestion = null;

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (c)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function highlightMatch(name, q){
      if (!q) return escapeHtml(name);
      const idx = name.toLowerCase().indexOf(q.toLowerCase());
      if (idx === -1) return escapeHtml(name);
      const before = name.slice(0, idx);
      const match = name.slice(idx, idx + q.length);
      const after = name.slice(idx + q.length);
      return `${escapeHtml(before)}<span class="match">${escapeHtml(match)}</span>${escapeHtml(after)}`;
    }

    function renderSuggestions(list, q){
      suggestions = list || [];
      activeIndex = -1;
      suggestionsEl.innerHTML = '';
      if (!suggestions.length){ suggestionsEl.classList.remove('show'); return; }
      suggestions.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.setAttribute('role','option');
        div.dataset.index = i;

        const avatarWrap = document.createElement('div');
        avatarWrap.className = 's-avatar';
        if (item.PhotoURL) { avatarWrap.style.backgroundImage = `url(${item.PhotoURL})`; avatarWrap.style.backgroundSize = 'cover'; avatarWrap.textContent = ''; }
        else {
          const parts = (item.Name || '').trim().split(' ');
          const initials = (parts[0] ? parts[0][0] : '') + (parts[1] ? parts[1][0] : '');
          avatarWrap.textContent = initials || '—';
        }

        const meta = document.createElement('div'); meta.className = 's-meta';
        const name = document.createElement('div'); name.className = 's-name';
        name.innerHTML = highlightMatch(item.Name || '—', q);
        const id = document.createElement('div'); id.className = 's-id'; id.textContent = 'ID: ' + (item.MemberID || '—');
        const course = document.createElement('div'); course.className = 's-course'; course.textContent = 'Course: ' + (item.Course || '—');

        meta.appendChild(name); meta.appendChild(id); meta.appendChild(course);
        div.appendChild(avatarWrap); div.appendChild(meta);

        div.addEventListener('click', ()=> openConfirmForSuggestion(i));
        suggestionsEl.appendChild(div);
      });
      suggestionsEl.classList.add('show');
    }

    function highlightActive(){
      const nodes = Array.from(suggestionsEl.querySelectorAll('.suggestion'));
      nodes.forEach((n, i) => n.classList.toggle('active', i === activeIndex));
      if (activeIndex >= 0 && nodes[activeIndex]) nodes[activeIndex].scrollIntoView({block:'nearest'});
    }

    function openConfirmForSuggestion(i){
      if (i < 0 || i >= suggestions.length) return;
      selectedSuggestion = suggestions[i];
      cd_name.textContent = selectedSuggestion.Name || '—';
      cd_id.textContent = selectedSuggestion.MemberID || '—';
      cd_course.textContent = selectedSuggestion.Course || '—';
      if (selectedSuggestion.PhotoURL) { cAvatar.style.backgroundImage = `url(${selectedSuggestion.PhotoURL})`; cAvatar.textContent = ''; }
      else {
        const parts = (selectedSuggestion.Name || '').trim().split(' ');
        const initials = (parts[0] ? parts[0][0] : '') + (parts[1] ? parts[1][0] : '');
        cAvatar.style.backgroundImage = 'none'; cAvatar.textContent = initials || '—';
      }
      confirmBackdrop.classList.add('show'); confirmBackdrop.style.display = 'flex';
      suggestionsEl.classList.remove('show');
    }

    // keyboard for suggestions
    queryEl.addEventListener('keydown', (e) => {
      if (suggestionsEl.classList.contains('show')) {
        if (e.key === 'ArrowDown') { e.preventDefault(); activeIndex = Math.min(activeIndex + 1, suggestions.length -1); highlightActive(); return; }
        if (e.key === 'ArrowUp') { e.preventDefault(); activeIndex = Math.max(activeIndex - 1, 0); highlightActive(); return; }
        if (e.key === 'Enter') {
          if (activeIndex >= 0) { e.preventDefault(); openConfirmForSuggestion(activeIndex); return; }
        }
        if (e.key === 'Escape') { suggestionsEl.classList.remove('show'); return; }
      }
      if (e.key === 'Enter' && !suggestionsEl.classList.contains('show')) doSearch();
    });

    function requestSuggestions(q){
      if (!q) { renderSuggestions([], q); return; }
      try {
        google.script.run.withSuccessHandler(list => {
          if (!Array.isArray(list)) { renderSuggestions([], q); return; }
          renderSuggestions(list, q);
        }).withFailureHandler(err => {
          renderSuggestions([], q);
          console.warn('searchMembersPrefix not available or failed', err);
        }).searchMembersPrefix(q);
      } catch (e) {
        console.warn('google.script.run missing', e);
        renderSuggestions([], q);
      }
    }
    const debouncedRequest = debounce(requestSuggestions, 260);

    queryEl.addEventListener('input', (e)=> {
      const val = (e.target.value || '').trim();
      if (!val) { suggestionsEl.classList.remove('show'); return; }
      debouncedRequest(val);
    });

    document.addEventListener('click', (ev)=> { if (!ev.target.closest('.searchCard')) suggestionsEl.classList.remove('show'); });

    // searching & backend calls
    function doSearch(){ const q = (queryEl.value || '').trim(); if (!q){ showToast('Enter member id or name'); return; } searchBtn.disabled=true; searchBtn.textContent='Searching...'; google.script.run.withSuccessHandler(onSearchSuccess).withFailureHandler(onError).getMemberByIdOrName(q); }
    function searchByMemberID(memberId){ if (!memberId){ showToast('Invalid ID'); return; } searchBtn.disabled=true; searchBtn.textContent='Searching...'; google.script.run.withSuccessHandler(onSearchSuccess).withFailureHandler(onError).getMemberByIdOrName(memberId); }

    searchBtn.addEventListener('click', ()=> {
      if (suggestionsEl.classList.contains('show') && activeIndex >= 0) openConfirmForSuggestion(activeIndex);
      else doSearch();
    });

    cd_cancel.addEventListener('click', ()=> { confirmBackdrop.classList.remove('show'); setTimeout(()=> confirmBackdrop.style.display='none',200); queryEl.focus(); });
    cd_confirm.addEventListener('click', ()=> {
      if (!selectedSuggestion) { confirmBackdrop.classList.remove('show'); setTimeout(()=> confirmBackdrop.style.display='none',200); return; }
      confirmBackdrop.classList.remove('show'); setTimeout(()=> confirmBackdrop.style.display='none',200);
      searchByMemberID(selectedSuggestion.MemberID);
    });

    window.addEventListener('keydown', (e)=> {
      if (confirmBackdrop.classList.contains('show')) {
        if (e.key === 'Enter') { e.preventDefault(); cd_confirm.click(); }
        if (e.key === 'Escape') { e.preventDefault(); cd_cancel.click(); }
      }
    });

    function onSearchSuccess(payload){
      searchBtn.disabled = false; searchBtn.textContent = 'Search';
      suggestionsEl.classList.remove('show');
      if (!payload || !payload.found){ showToast('Member not found'); return; }
      const m = payload.member || {};
      memberNameEl.textContent = m.Name || '—';
      memberIdEl.textContent = 'ID: ' + (m.MemberID || '—');
      memberAdditional.textContent = (m.Course ? ('Course: ' + m.Course) : (m.Additional || ''));
      timestamps.textContent = payload.latest || 'No previous visits';
      statusBadge.textContent = payload.status || '—';
      statusBadge.className = payload.status === 'IN' ? 'status in' : 'status out';
      visitInBtn.dataset.memberid = m.MemberID; visitOutBtn.dataset.memberid = m.MemberID;

      if (m.PhotoURL) { avatar.style.backgroundImage = `url(${m.PhotoURL})`; avatar.style.backgroundSize = 'cover'; avatar.textContent = ''; }
      else { const parts = (m.Name || '').trim().split(' '); const initials = (parts[0] ? parts[0][0] : '') + (parts[1] ? parts[1][0] : ''); avatar.textContent = initials || '—'; avatar.style.backgroundImage = 'none'; }
      avatar.classList.add('show');

      resultCard.classList.add('show'); setTimeout(()=> actionRow.classList.add('show'), 180); setTimeout(()=> visitInBtn.focus(), 260);
      queryEl.value = '';
      resetIdleTimer();
    }

    function onError(err){ searchBtn.disabled = false; searchBtn.textContent = 'Search'; showToast('Server error'); console.error(err); }

    // check-in/out
    visitInBtn.addEventListener('click', ()=> {
      const memberId = visitInBtn.dataset.memberid;
      if (!memberId){ showToast('No member selected. Search first.'); return; }
      showToast('Recording Visit In...');
      google.script.run.withSuccessHandler(onRecordIn).withFailureHandler(onError).recordVisit(memberId, 'IN', '');
    });

    function onRecordIn(payload){
      if (!payload || !payload.ok){ showToast(payload && payload.error ? payload.error : 'Failed to record'); return; }
      const name = memberNameEl.textContent || '—';
      const id = visitInBtn.dataset.memberid || '—';
      const ts = payload.timestamp || new Date().toLocaleString();
      c_memberName.textContent = name; c_memberId.textContent = id; c_timeIn.textContent = ts;
      confirmSmall.classList.add('show');
      welcomeBackdrop.classList.add('show'); welcomeBackdrop.style.display = 'flex';
      showToast('Checked in at ' + ts);
      google.script.run.withSuccessHandler(onSearchSuccess).withFailureHandler(onError).getMemberByIdOrName(payload.memberId);
      resetIdleTimer();
    }

    visitOutBtn.addEventListener('click', ()=> {
      const memberId = visitOutBtn.dataset.memberid;
      if (!memberId){ showToast('No member selected. Search first.'); return; }
      showToast('Recording Visit Out...');
      google.script.run.withSuccessHandler(onRecordOut).withFailureHandler(onError).recordVisit(memberId, 'OUT', 'Checked out via web');
    });

    function onRecordOut(payload){
      if (!payload || !payload.ok){ showToast(payload && payload.error ? payload.error : 'Failed to record'); return; }
      o_memberName.textContent = memberNameEl.textContent || '—';
      o_memberId.textContent = visitOutBtn.dataset.memberid || '—';
      o_timeOut.textContent = payload.timestamp || new Date().toLocaleString();
      outOverlay.classList.add('show'); outOverlay.style.display = 'flex';
      setTimeout(()=> { outOverlay.classList.remove('show'); outOverlay.style.display = 'none'; }, 2200);
      showToast('Checked out at ' + payload.timestamp);
      google.script.run.withSuccessHandler(onSearchSuccess).withFailureHandler(onError).getMemberByIdOrName(payload.memberId);
      resetIdleTimer();
    }

    function showToast(msg) {
      toast.textContent = msg; toast.style.display = 'block';
      clearTimeout(window._tt); window._tt = setTimeout(()=> toast.style.display = 'none', 2600);
    }

    rulesBtn.addEventListener('click', ()=> { confirmSmall.classList.remove('show'); welcomeBackdrop.classList.add('show'); welcomeBackdrop.style.display = 'flex'; });
    closeWelcomeBtn.addEventListener('click', ()=> { welcomeBackdrop.classList.remove('show'); setTimeout(()=> welcomeBackdrop.style.display = 'none', 300); resetIdleTimer(); });

    google.script.run.withSuccessHandler(isAdmin => { if (isAdmin) document.getElementById('adminPanel').style.display = 'block'; }).isCurrentUserAdmin();

    const exportTodayBtn = document.getElementById('exportTodayBtn');
    const genDurationsBtn = document.getElementById('genDurationsBtn');
    if (exportTodayBtn) exportTodayBtn.addEventListener('click', ()=> {
      exportTodayBtn.disabled = true; exportTodayBtn.textContent = 'Exporting...';
      google.script.run.withSuccessHandler(res => { exportTodayBtn.disabled=false; exportTodayBtn.textContent='Export'; if (res && res.url) window.open(res.url,'_blank'); else showToast('Export failed'); }).withFailureHandler(err => { exportTodayBtn.disabled=false; exportTodayBtn.textContent='Export'; showToast('Export failed'); console.error(err); }).exportTodayVisits();
    });
    if (genDurationsBtn) genDurationsBtn.addEventListener('click', ()=> {
      genDurationsBtn.disabled = true; genDurationsBtn.textContent = 'Generating...';
      google.script.run.withSuccessHandler(res => { genDurationsBtn.disabled=false; genDurationsBtn.textContent='Durations'; if (res && res.sheetUrl) window.open(res.sheetUrl,'_blank'); else showToast('Report failed'); }).withFailureHandler(err => { genDurationsBtn.disabled=false; genDurationsBtn.textContent='Durations'; showToast('Report failed'); console.error(err); }).generateDurationsReport();
    });

    /* Idle timeout (kiosk) */
    const IDLE_TIMEOUT_MS = 90000;
    let idleTimer;
    function resetIdleTimer(){ clearTimeout(idleTimer); idleTimer = setTimeout(()=> { showWelcomeDueIdle(); }, IDLE_TIMEOUT_MS); }
    function showWelcomeDueIdle(){ resultCard.classList.remove('show'); actionRow.classList.remove('show'); confirmSmall.classList.remove('show'); welcomeBackdrop.classList.add('show'); welcomeBackdrop.style.display = 'flex'; }
    ['mousemove','keydown','click','touchstart'].forEach(evt => window.addEventListener(evt, resetIdleTimer, {passive:true}));
    resetIdleTimer();
    closeWelcomeBtn.addEventListener('click', ()=> { resetIdleTimer(); });

  </script>

  <!-- Created by Saket Sharma -->
</body>
</html>
